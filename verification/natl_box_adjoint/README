# Example: Subtropical North Atlantic and Labrador Sea Areas
# ==========================================================
# - forward/adjoint run
# - optimization cost function
# - with KPP & shortwave heating
# - gmredi turned off (until merge to c48)
# - The input data is real*8
# - 4 timesteps

####################
# Experiment no. 1 #
####################
# Use air-sea fluxes as controls (standard case):
# perform gradient checks for first four elements of the
# heat flux part of the control vector (grdchkvarindex = 3).

# Compile code in bin/:
 cd bin
 cp ../verification/natl_box_adjoint/code/.genmakerc .
 cp ../verification/natl_box_adjoint/code/*.h .
# Configure and compile the code:
 ../tools/genmake -makefile
 make depend
# Generate the adjoint code:
 cd ../adjoint
 make adtaf
 make adchange
# Go back and compile the code:
 cd ../bin
 make
# To run:
 cd ../exe
 cp ../verification/natl_box_adjoint/input/* .
 ./mitgcmuv >&! output.txt
# To verify the results of the gradient check, type:
 grep "ph-grd 3" output.txt
# A reference output is in:
 grep "ph-grd 3" ../verification/natl_box_adjoint/results/output.txt


####################
# Experiment no. 2 #
####################
# Use bulk formulae and atmospheric state controls
# (only differences to experiment 1 are in
# ECCO_CPPOPTIONS.h and in data.grdchk):
# perform gradient checks for first four elements of the
# air temperture part of the control vector (grdchkvarindex = 7).

# Compile code in bin/:
 cd ../bin
 rm -rf *.o *.f *.p rii_files
 rm -rf *.F *.h *.c Makefile*
 cp ../verification/natl_box_adjoint/code_bulk/.genmakerc .
 cp ../verification/natl_box_adjoint/code_bulk/*.h .
# Configure and compile the code:
 ../tools/genmake -makefile
 make depend
# Generate the adjoint code:
 cd ../adjoint
 make adtaf
 make adchange
# Go back and compile the code:
 cd ../bin
 make
# To run:
 cd ../exe
 cp ../verification/natl_box_adjoint/input_bulk/* .
 cp ../verification/natl_box_adjoint/input/PH_*.data .
 ./mitgcmuv >&! output.txt
# To verify the results of the gradient check, type:
 grep "ph-grd 3" output.txt
# A reference output is in:
 grep "ph-grd 3" ../verification/natl_box_adjoint/results_bulk/output.txt


####################
# Experiment no. 4 #
####################
# Same as exp. 2, but with ALLOW_SEAICE defined and useseaice = .true.

# Compile code in bin/:
 cd ../bin
 rm -rf *.o *.f *.p rii_files
 rm -rf *.F *.h *.c Makefile*
 cp ../verification/natl_box_adjoint/code_seaice/*.h .
 cp ../verification/natl_box_adjoint/code_seaice/.genmakerc .
 cp ../verification/natl_box_adjoint/code_seaice/SEAICE_OPTIONS.h.FLUXES SEAICE_OPTIONS.h
# Configure and compile the code:
 ../tools/genmake -makefile
 make depend
# Generate the adjoint code:
 cd ../adjoint
 cp ../verification/natl_box_adjoint/code_seaice/makefile .
 make adtaf
 make adchange
 rm -f makefile
# Go back and compile the code:
 cd ../bin
 make
# To run:
 cd ../exe
 cp ../verification/natl_box_adjoint/input_bulk/* .
 cp ../verification/natl_box_adjoint/input_seaice/data.seaice.cgrid data.seaice
 cp ../verification/natl_box_adjoint/input_seaice/data.pkg .
 cp ../verification/natl_box_adjoint/input/PH_*.data .
 ./mitgcmuv >&! output.txt
# To verify the results of the gradient check, type:
 grep "ph-grd 3" output.txt
# A reference output is in:
 grep "ph-grd 3" ../verification/natl_box_adjoint/results_bulk/output.txt


####################
# Experiment no. 5 #
####################
# Same as exp. 4, but using sea-ice bulk formulae.
# This experiment tests pkg/seaice bulk formulae over open water.
# No sea-ice is formed anywhere in the domain.
# There is a discrepancy of up to 8% between ajoint
# model and finite difference gradients.

# Compile code in bin/:
 cd ../bin
 rm -rf *.o *.f *.p rii_files
 rm -rf *.F *.h *.c Makefile*
 cp ../verification/natl_box_adjoint/code_seaice/*.h .
 cp ../verification/natl_box_adjoint/code_seaice/.genmakerc .
# Configure and compile the code:
 ../tools/genmake -makefile
 make depend
# Generate the adjoint code:
 cd ../adjoint
 cp ../verification/natl_box_adjoint/code_seaice/makefile .
 make adtaf
 make adchange
 rm -f makefile
# Go back and compile the code:
 cd ../bin
 make
# To run:
 cd ../exe
 cp ../verification/natl_box_adjoint/input_bulk/* .
 cp ../verification/natl_box_adjoint/input_seaice/data.seaice.cgrid data.seaice
 cp ../verification/natl_box_adjoint/input_seaice/data.pkg .
 cp ../verification/natl_box_adjoint/input/PH_*.data .
 ./mitgcmuv >&! output.txt
# To verify the results of the gradient check, type:
 grep "ph-grd 3" output.txt
# A reference output is in:
 grep "ph-grd 3" ../verification/natl_box_adjoint/results_bulk/output.exp5

# undef DO_WE_NEED_THIS in growth.F makes no difference to exp. 5
# explicitly setting area to 0 in growth.F also makes no difference
# commenting out dynsolver and advect in sea_model also makes litle difference

   adj grad         grdchk_eps  fd grad
   0.162042259E-03  1.d-10      0.100000000E+01
                    1.d-8       0.147792889E-03
                    1.d-6       0.149270818E-03
                    1.d-4       0.149204311E-03
                    1.d-2       0.149203527E-03
                    1.d0        0.153830983E-03
                    1.d1        0.145168163E-03

 grdchk_eps       = 1.d-10,
 ph-grd 3 -------------------------------
 ph-grd 3  proc    #    i    j    k            fc ref        fc + eps        fc - eps
 ph-grd 3  proc    #    i    j    k          adj grad         fd grad      1 - fd/adj
 ph-grd 3 -------------------------------
 ph-grd 3     0    1    8    3    1   0.869478978E+03 0.869478978E+03 0.869478978E+03
 ph-grd 3     0    1    1   20    0   0.282368284E-02 0.227373675E-02 0.194761989E+00
 ph-grd 3 -------------------------------
 ph-grd 3     0    2    2    5    1   0.869478978E+03 0.869478978E+03 0.869478978E+03
 ph-grd 3     0    2    2   40    0   0.162042259E-03 0.000000000E+00 0.100000000E+01
 ph-grd 3 -------------------------------
 ph-grd 3     0    3    9    6    1   0.869478978E+03 0.869478978E+03 0.869478978E+03
 ph-grd 3     0    3    3   60    0   0.350757987E-02 0.341060513E-02 0.276471932E-01
 ph-grd 3 -------------------------------
 ph-grd 3     0    4    3    8    1   0.869478978E+03 0.869478978E+03 0.869478978E+03
 ph-grd 3     0    4    4   80    0   0.278077239E-03 0.113686838E-02 -.308831870E+01

 grdchk_eps       = 1.d-8,
 ph-grd 3 -------------------------------
 ph-grd 3  proc    #    i    j    k            fc ref        fc + eps        fc - eps
 ph-grd 3  proc    #    i    j    k          adj grad         fd grad      1 - fd/adj
 ph-grd 3 -------------------------------
 ph-grd 3     0    1    8    3    1   0.869478978E+03 0.869478978E+03 0.869478978E+03
 ph-grd 3     0    1    1   20    0   0.282368284E-02 0.274553713E-02 0.276751012E-01
 ph-grd 3 -------------------------------
 ph-grd 3     0    2    2    5    1   0.869478978E+03 0.869478978E+03 0.869478978E+03
 ph-grd 3     0    2    2   40    0   0.162042259E-03 0.147792889E-03 0.879361332E-01
 ph-grd 3 -------------------------------
 ph-grd 3     0    3    9    6    1   0.869478978E+03 0.869478978E+03 0.869478978E+03
 ph-grd 3     0    3    3   60    0   0.350757987E-02 0.349587026E-02 0.333837304E-02
 ph-grd 3 -------------------------------
 ph-grd 3     0    4    3    8    1   0.869478978E+03 0.869478978E+03 0.869478978E+03
 ph-grd 3     0    4    4   80    0   0.278077239E-03 0.272848411E-03 0.188035117E-01

 grdchk_eps       = 1.d-6,
 ph-grd 3 -------------------------------
 ph-grd 3  proc    #    i    j    k            fc ref        fc + eps        fc - eps
 ph-grd 3  proc    #    i    j    k          adj grad         fd grad      1 - fd/adj
 ph-grd 3 -------------------------------
 ph-grd 3     0    1    8    3    1   0.869478978E+03 0.869478978E+03 0.869478978E+03
 ph-grd 3     0    1    1   20    0   0.282368284E-02 0.274133072E-02 0.291647916E-01
 ph-grd 3 -------------------------------
 ph-grd 3     0    2    2    5    1   0.869478978E+03 0.869478978E+03 0.869478978E+03
 ph-grd 3     0    2    2   40    0   0.162042259E-03 0.149270818E-03 0.788154945E-01
 ph-grd 3 -------------------------------
 ph-grd 3     0    3    9    6    1   0.869478978E+03 0.869478978E+03 0.869478978E+03
 ph-grd 3     0    3    3   60    0   0.350757987E-02 0.349803031E-02 0.272254960E-02
 ph-grd 3 -------------------------------
 ph-grd 3     0    4    3    8    1   0.869478978E+03 0.869478978E+03 0.869478978E+03
 ph-grd 3     0    4    4   80    0   0.278077239E-03 0.265913513E-03 0.437422558E-01

 grdchk_eps       = 1.d-4,
 ph-grd 3 -------------------------------
 ph-grd 3  proc    #    i    j    k            fc ref        fc + eps        fc - eps
 ph-grd 3  proc    #    i    j    k          adj grad         fd grad      1 - fd/adj
 ph-grd 3 -------------------------------
 ph-grd 3     0    1    8    3    1   0.869478978E+03 0.869478979E+03 0.869478978E+03
 ph-grd 3     0    1    1   20    0   0.282368284E-02 0.274122783E-02 0.292012286E-01
 ph-grd 3 -------------------------------
 ph-grd 3     0    2    2    5    1   0.869478978E+03 0.869478978E+03 0.869478978E+03
 ph-grd 3     0    2    2   40    0   0.162042259E-03 0.149204311E-03 0.792259233E-01
 ph-grd 3 -------------------------------
 ph-grd 3     0    3    9    6    1   0.869478978E+03 0.869478979E+03 0.869478978E+03
 ph-grd 3     0    3    3   60    0   0.350757987E-02 0.349807408E-02 0.271007107E-02
 ph-grd 3 -------------------------------
 ph-grd 3     0    4    3    8    1   0.869478978E+03 0.869478978E+03 0.869478978E+03
 ph-grd 3     0    4    4   80    0   0.278077239E-03 0.265789026E-03 0.441899267E-01

 grdchk_eps       = 1.d-2,
 ph-grd 3 -------------------------------
 ph-grd 3  proc    #    i    j    k            fc ref        fc + eps        fc - eps
 ph-grd 3  proc    #    i    j    k          adj grad         fd grad      1 - fd/adj
 ph-grd 3 -------------------------------
 ph-grd 3     0    1    8    3    1   0.869478978E+03 0.869479006E+03 0.869478951E+03
 ph-grd 3     0    1    1   20    0   0.282368284E-02 0.274123143E-02 0.291999543E-01
 ph-grd 3 -------------------------------
 ph-grd 3     0    2    2    5    1   0.869478978E+03 0.869478980E+03 0.869478977E+03
 ph-grd 3     0    2    2   40    0   0.162042259E-03 0.149203527E-03 0.792307642E-01
 ph-grd 3 -------------------------------
 ph-grd 3     0    3    9    6    1   0.869478978E+03 0.869479013E+03 0.869478943E+03
 ph-grd 3     0    3    3   60    0   0.350757987E-02 0.349806868E-02 0.271160901E-02
 ph-grd 3 -------------------------------
 ph-grd 3     0    4    3    8    1   0.869478978E+03 0.869478981E+03 0.869478976E+03
 ph-grd 3     0    4    4   80    0   0.278077239E-03 0.265792312E-03 0.441781115E-01

 grdchk_eps       = 1.d0,
 ph-grd 3 -------------------------------
 ph-grd 3  proc    #    i    j    k            fc ref        fc + eps        fc - eps
 ph-grd 3  proc    #    i    j    k          adj grad         fd grad      1 - fd/adj
 ph-grd 3 -------------------------------
 ph-grd 3     0    1    8    3    1   0.869478978E+03 0.869483158E+03 0.869477730E+03
 ph-grd 3     0    1    1   20    0   0.282368284E-02 0.271435042E-02 0.387197940E-01
 ph-grd 3 -------------------------------
 ph-grd 3     0    2    2    5    1   0.869478978E+03 0.869480701E+03 0.869480394E+03
 ph-grd 3     0    2    2   40    0   0.162042259E-03 0.153830983E-03 0.506736699E-01
 ph-grd 3 -------------------------------
 ph-grd 3     0    3    9    6    1   0.869478978E+03 0.869483813E+03 0.869476821E+03
 ph-grd 3     0    3    3   60    0   0.350757987E-02 0.349580377E-02 0.335732919E-02
 ph-grd 3 -------------------------------
 ph-grd 3     0    4    3    8    1   0.869478978E+03 0.869480324E+03 0.869479795E+03
 ph-grd 3     0    4    4   80    0   0.278077239E-03 0.264401119E-03 0.491810108E-01

 grdchk_eps       = 1.d1,
 ph-grd 3 -------------------------------
 ph-grd 3  proc    #    i    j    k            fc ref        fc + eps        fc - eps
 ph-grd 3  proc    #    i    j    k          adj grad         fd grad      1 - fd/adj
 ph-grd 3 -------------------------------
 ph-grd 3     0    1    8    3    1   0.869478978E+03 0.869655230E+03 0.869599892E+03
 ph-grd 3     0    1    1   20    0   0.282368284E-02 0.276691733E-02 0.201033597E-01
 ph-grd 3 -------------------------------
 ph-grd 3     0    2    2    5    1   0.869478978E+03 0.869636587E+03 0.869633684E+03
 ph-grd 3     0    2    2   40    0   0.162042259E-03 0.145168163E-03 0.104133920E+00
 ph-grd 3 -------------------------------
 ph-grd 3     0    3    9    6    1   0.869478978E+03 0.869649107E+03 0.869577908E+03
 ph-grd 3     0    3    3   60    0   0.350757987E-02 0.355998258E-02 -.149398484E-01
 ph-grd 3 -------------------------------
 ph-grd 3     0    4    3    8    1   0.869478978E+03 0.869589785E+03 0.869584664E+03
 ph-grd 3     0    4    4   80    0   0.278077239E-03 0.256034057E-03 0.792699979E-01

####################
# Experiment no. 6 #
####################
# Same as experiment 5, but in the Labrador Sea rather than in
# the North Atlantic subduction region.  The cost function is
# total ice volume over the 4-hour test period.
#
# The cost function data files are not used.  They contain:
# labsea_TP_fields   : filled with -9999
# labsea_TP_mean     : hour 100 ssh (cm) of lab_sea experiment
# labsea_ERS_fields  : filled with -9999
# labsea_SST_fields  : 14 * Levitus annual mean SST
# labsea_Lev.ptmp    : 14 * Levitus annual mean temperature
# labsea_Lev.salt    : 14 * Levitus annual mean salinity
# labsea_ssh.err     : filled with -9999
# labsea_geoid.err   : constant 0.2 with -9999 landmask
# labsea_totflux.err : 100 with -9999 landmask
# labsea_pme.err     : 4e-8 with -9999 landmask
# labsea_ustress.err : 3 with -9999 landmask
# labsea_vstress.err : 3 with -9999 landmask
#
# There are large differences between adjoint and finite
# difference gradients, but see Experiment 7.

# To run:
 cd ../exe
 cp ../verification/natl_box_adjoint/input_seaice/* .
 cp ../verification/natl_box_adjoint/input_bulk/data.grdchk .
 ./mitgcmuv >&! output.txt
# To verify the results of the gradient check, type:
 grep "ph-grd 3" output.txt
# A reference output is in:
 grep "ph-grd 3" ../verification/natl_box_adjoint/results_seaice/output.txt


####################
# Experiment no. 7 #
####################
# Same as experiment 6, but finite difference gradient check for
# air temperature is computed and compared for the complete domain.
#
# Notes:
# variables xx_* contain control vector perturbation
# variables adxx_* contain cost function gradient relative to control

# To run:
 cd ../exe
 cp ../verification/natl_box_adjoint/input_seaice/* .
 ./mitgcmuv >&! output.txt
# To verify the results of the gradient check, type:
 grep "ph-grd 3" output.txt > ph-grd.txt
 cd ../verification/natl_box_adjoint/results_seaice
 matlab
 lookat_exp8


####################
# Experiment no. 8 #
####################
# Same as experiment 7, but starting from a checkpoint file.

# To run:
 cd ../exe
 cp ../verification/natl_box_adjoint/input_seaice/* .
 cp data.001 data
 ./mitgcmuv >&! output.txt
# To verify the results of the gradient check, type:
 grep "ph-grd 3" output.txt > ph-grd.txt
 cd ../verification/natl_box_adjoint/results_seaice
 matlab
 lookat_exp8


####################
# Experiment no. 9 #
####################
# Same as experiment 8, but starting from time step 180.
# This includes a location (12,8) which experiences a phase
# transition from no-ice to sea-ice, and which therefore has
# a very large and inaccurate gradient.

# To run:
 cd ../exe
 cp ../verification/natl_box_adjoint/input_seaice/* .
 cp data.180 data
 ./mitgcmuv >&! output.txt
# To verify the results of the gradient check, type:
 grep "ph-grd 3" output.txt > ph-grd.txt
 cd ../verification/natl_box_adjoint/results_seaice
 matlab
 lookat_exp8


#####################
# Experiment no. 10 #
#####################
# Set up a 100-day sensitivity experiment.
# Things start falling apart, see below.
# Longer integrations periods cause NANs in adjoint gradient.
# Note: cost_ssh is hardwired for 1-day ssh records
#       "topexperiod" in data.cost is never used.

# Compile code in bin/:
 cd ../bin
 rm -rf *.o *.f *.p rii_files
 rm -rf *.F *.h *.c Makefile*
 cp ../verification/natl_box_adjoint/code_seaice/*.h .
 rm -f tamc.h
 cp ../verification/natl_box_adjoint/code_seaice/.genmakerc .
# Configure and compile the code:
 ../tools/genmake -makefile
 make depend
# Generate the adjoint code:
 cd ../adjoint
 cp ../verification/natl_box_adjoint/code_seaice/makefile .
 make adtaf
 make adchange
 rm -f makefile
# Go back and compile the code:
 cd ../bin
 make
# To run:
 cd ../exe
 cp ../verification/natl_box_adjoint/input_seaice/* .
 cp data.100day data
 cp ../verification/natl_box_adjoint/input_bulk/data.grdchk .
 ./mitgcmuv >&! output.txt

# To verify the results of the gradient check, type:
 grep "ph-grd 3" output.txt

 adj grad -.441946498+276 -.143062040+277 -.116360092+277 0.400428239+277
 1.d-16
 1.d-8    0.174714613E+16 -.527867903E+15 0.403581037E+15 0.377322748E+12
 1.d-4    0.999954825E+11 0.156018218E+12 -.474931072E+11 -.357260091E+11
 1.d-2    0.634576350E+09 -.185440863E+10 -.599212833E+09 -.334417056E+10

 grdchk_eps       = 1.d-16,

 grdchk_eps       = 1.d-8,
 ph-grd 3 -------------------------------
 ph-grd 3  proc    #    i    j    k            fc ref        fc + eps        fc - eps
 ph-grd 3  proc    #    i    j    k          adj grad         fd grad      1 - fd/adj
 ph-grd 3 -------------------------------
 ph-grd 3     0    1   17    2    1   0.450078085E+12 0.450110787E+12 0.450075844E+12
 ph-grd 3     0    1    1   20    0   -.441946498+276 0.174714613E+16 0.100000000E+01
 ph-grd 3 -------------------------------
 ph-grd 3     0    2   20    4    1   0.450078085E+12 0.450071774E+12 0.450082332E+12
 ph-grd 3     0    2    2   40    0   -.143062040+277 -.527867903E+15 0.100000000E+01
 ph-grd 3 -------------------------------
 ph-grd 3     0    3   19    6    1   0.450078085E+12 0.450102141E+12 0.450094070E+12
 ph-grd 3     0    3    3   60    0   -.116360092+277 0.403581037E+15 0.100000000E+01
 ph-grd 3 -------------------------------
 ph-grd 3     0    4   11    8    1   0.450078085E+12 0.450094556E+12 0.450094549E+12
 ph-grd 3     0    4    4   80    0   0.400428239+277 0.377322748E+12 0.100000000E+01

 grdchk_eps       = 1.d-4,
 ph-grd 3 -------------------------------
 ph-grd 3  proc    #    i    j    k            fc ref        fc + eps        fc - eps
 ph-grd 3  proc    #    i    j    k          adj grad         fd grad      1 - fd/adj
 ph-grd 3 -------------------------------
 ph-grd 3     0    1   17    2    1   0.450078085E+12 0.450116952E+12 0.450096953E+12
 ph-grd 3     0    1    1   20    0   -.441946498+276 0.999954825E+11 0.100000000E+01
 ph-grd 3 -------------------------------
 ph-grd 3     0    2   20    4    1   0.450078085E+12 0.450102453E+12 0.450071250E+12
 ph-grd 3     0    2    2   40    0   -.143062040+277 0.156018218E+12 0.100000000E+01
 ph-grd 3 -------------------------------
 ph-grd 3     0    3   19    6    1   0.450078085E+12 0.450084354E+12 0.450093853E+12
 ph-grd 3     0    3    3   60    0   -.116360092+277 -.474931072E+11 0.100000000E+01
 ph-grd 3 -------------------------------
 ph-grd 3     0    4   11    8    1   0.450078085E+12 0.450093326E+12 0.450100471E+12
 ph-grd 3     0    4    4   80    0   0.400428239+277 -.357260091E+11 0.100000000E+01

 grdchk_eps       = 1.d-2,
 ph-grd 3 -------------------------------
 ph-grd 3  proc    #    i    j    k            fc ref        fc + eps        fc - eps
 ph-grd 3  proc    #    i    j    k          adj grad         fd grad      1 - fd/adj
 ph-grd 3 -------------------------------
 ph-grd 3     0    1   17    2    1   0.450078085E+12 0.450080561E+12 0.450067869E+12
 ph-grd 3     0    1    1   20    0   -.441946498+276 0.634576350E+09 0.100000000E+01
 ph-grd 3 -------------------------------
 ph-grd 3     0    2   20    4    1   0.450078085E+12 0.450060914E+12 0.450098002E+12
 ph-grd 3     0    2    2   40    0   -.143062040+277 -.185440863E+10 0.100000000E+01
 ph-grd 3 -------------------------------
 ph-grd 3     0    3   19    6    1   0.450078085E+12 0.450057773E+12 0.450069757E+12
 ph-grd 3     0    3    3   60    0   -.116360092+277 -.599212833E+09 0.100000000E+01
 ph-grd 3 -------------------------------
 ph-grd 3     0    4   11    8    1   0.450078085E+12 0.450037391E+12 0.450104274E+12
 ph-grd 3     0    4    4   80    0   0.400428239+277 -.334417056E+10 0.100000000E+01


#####################
# Experiment no. 11 #
#####################
# Same as experiment 8, but using 2-CPU MPI configuration.

# Compile code in bin/:
 cd ../bin
 rm -rf *.o *.f *.p rii_files
 rm -rf *.F *.h *.c Makefile*
 cp ../verification/natl_box_adjoint/code_seaice/*.h .
 cp ../verification/natl_box_adjoint/code_seaice/.genmakerc .
 cp ../verification/natl_box_adjoint/code_seaice/SIZE.h.MPI SIZE.h
 cp ../verification/natl_box_adjoint/code_seaice/CPP_EEOPTIONS.h.MPI CPP_EEOPTIONS.h
# Configure and compile the code:
 ../tools/genmake -mpi -makefile
# ==> on alhena use:
# ../tools/genmake -platform=o2k -mpi -makefile
 make depend
# Generate the adjoint code:
 cd ../adjoint
 cp ../verification/natl_box_adjoint/code_seaice/makefile .
 make adtaf
 make adchange
 rm -f makefile
# Go back and compile the code:
 cd ../bin
 make

# To run:
 cd ../exe
 cp ../verification/natl_box_adjoint/input_seaice/* .
 cp data.001 data
 cp ../verification/natl_box_adjoint/input_bulk/data.grdchk .
 mpirun -np 2 mitgcmuv
# To verify the results of the gradient check, type:
 grep "ph-grd 3" STDOUT.0000
# To plot adjoint sensitivy fields
 cd ../verification/natl_box_adjoint/results_seaice
 matlab
 lookat_exp10


#####################
# Experiment no. 12 #
#####################
# Same as experiment 10, but including ADI dynamic solver.

# Compile code in bin/:
 cd ../bin
 rm -rf *.o *.f *.p rii_files
 rm -rf *.F *.h *.c Makefile*
 cp ../verification/natl_box_adjoint/code_seaice/*.h .
 cp ../verification/natl_box_adjoint/code_seaice/.genmakerc .
 cp ../verification/natl_box_adjoint/code_seaice/SIZE.h.MPI SIZE.h
 cp ../verification/natl_box_adjoint/code_seaice/CPP_EEOPTIONS.h.MPI CPP_EEOPTIONS.h
 cp ../verification/natl_box_adjoint/code_seaice/SEAICE_OPTIONS.h.DYN SEAICE_OPTIONS.h
# Configure and compile the code:
 ../tools/genmake -mpi -makefile
# ==> on alhena use:
# ../tools/genmake -platform=o2k -mpi -makefile
 make depend
# Generate the adjoint code:
 cd ../adjoint
 cp ../verification/natl_box_adjoint/code_seaice/makefile.dyn makefile
 make adtaf
 make adchange
 rm -f makefile
# Go back and compile the code:
 cd ../bin
 make
# To run:
 cd ../exe
 cp ../verification/natl_box_adjoint/input_seaice/* .
 cp data.001 data
 cp ../verification/natl_box_adjoint/input_bulk/data.grdchk .
 mpirun -np 2 mitgcmuv
# To verify the results of the gradient check, type:
 grep "ph-grd 3" STDOUT.0000
# To plot adjoint sensitivy fields
 cd ../verification/natl_box_adjoint/results_seaice
 matlab
 lookat_exp10


#####################
# Experiment no. 13 #
#####################
# Same as experiment 10, but using divided adjoint.
